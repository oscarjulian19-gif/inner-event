// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Tenant {
  id          String   @id @default(uuid())
  name        String
  domain      String   @unique // e.g. "compensar.com"
  logo        String?  // URL or path
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  teams       Team[]
  purposes    Purpose[]
  megas       Mega[]
  objectives  Objective[]
  keyResults  KeyResult[]
  initiatives Initiative[]
  kanbanTasks KanbanTask[]
  rituals     Ritual[]
  
  // Emergent Strategy
  hardChoices            HardChoice[]
  strategicConversations StrategicConversation[]
  distinctiveCapabilities DistinctiveCapability[]
  marketValueMetrics     MarketValueMetric[]
  mutationLogs           MutationLog[]
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  name        String   // First Name
  lastName    String?  // Last Name
  password    String   @default("12345") // Default password as requested
  
  age         Int?
  gender      String?
  jobTitle    String?  // "Cargo"
  area        String?  // "Area"
  tenure      String?  // "Tiempo en la compania"
  hierarchyLevel Int?  @default(3) // 1=Company, 2=Area, 3=Team
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  role        UserRole @default(USER) // ADMIN or USER (OKR User)
  jobRole     JobRole? // TEAM_LEAD, MEMBER, SUPERVISOR
  
  discProfile DiscProfile?
  teams       TeamMember[]
  ledTeams    Team[]   @relation("TeamLeader")
  
  kanbanTasks KanbanTask[]
  
  // Owner relations
  ownedPurposes Purpose[] // New: Users can own purposes (Areas)
  ownedObjectives Objective[]
  ownedKeyResults KeyResult[]
  ownedInitiatives Initiative[]
  
  ritualParticipations RitualParticipant[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum UserRole {
  SUPERADMIN
  ADMIN
  USER
}

enum JobRole {
  TEAM_LEAD
  MEMBER
  SUPERVISOR
}

model DiscProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  color       DiscColor
  scores      String   // JSON string for detailed scores if needed
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum DiscColor {
  RED
  YELLOW
  GREEN
  BLUE
}

model Team {
  id          String   @id @default(uuid())
  name        String
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  members     TeamMember[]
  initiatives Initiative[]

  aiReasoning String? // New: "Conclusion de la IA"

  leaderId    String?
  leader      User?    @relation("TeamLeader", fields: [leaderId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      String?

  @@unique([teamId, userId])
}

// 1. Jerarquía Estratégica

model Purpose {
  id          String   @id @default(uuid())
  statement   String   // "Para Qué"
  type        PurposeType @default(COMPANY) // New
  
  ownerId     String? // New
  owner       User?   @relation(fields: [ownerId], references: [id])

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  megas       Mega[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum PurposeType {
  COMPANY
  AREA
  TEAM
}

model Mega {
  id          String   @id @default(uuid())
  statement   String   // "Gran Destino"
  deadline    DateTime
  purposeId   String
  purpose     Purpose  @relation(fields: [purposeId], references: [id])
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  objectives  Objective[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Objective {
  id          String   @id @default(uuid())
  statement   String
  description String?  // New
  
  megaId      String?  // Optional now? "El Objetivo a la MEGA o a otro objetivo"
  mega        Mega?    @relation(fields: [megaId], references: [id])
  
  parentObjectiveId String? // New: Recursive
  parentObjective   Objective? @relation("RecursiveObjectives", fields: [parentObjectiveId], references: [id])
  childObjectives   Objective[] @relation("RecursiveObjectives")

  ownerId     String? // New
  owner       User?   @relation(fields: [ownerId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  keyResults  KeyResult[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model KeyResult {
  id          String   @id @default(uuid())
  statement   String
  description String?  // New
  targetValue Float
  currentValue Float   @default(0)
  metricUnit  String   // e.g., "%", "USD", "Users"
  
  objectiveId String
  objective   Objective @relation(fields: [objectiveId], references: [id])
  
  ownerId     String? // New
  owner       User?   @relation(fields: [ownerId], references: [id])

  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  
  initiatives Initiative[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 3. Gestión de Iniciativas (Proyectos) & 2. Categorización (3 Horizontes)

model Initiative {
  id          String   @id @default(uuid())
  title       String
  description String?
  
  horizon     Horizon
  status      KanbanStatus @default(TODO) // Keep for high level status
  
  progress    Float    @default(0) // 0 to 100 (Derived from Tasks)
  
  keyResultId String
  keyResult   KeyResult @relation(fields: [keyResultId], references: [id])
  
  ownerId     String? // New
  owner       User?   @relation(fields: [ownerId], references: [id])

  // "La iniciativa clave permite traer los equipos armados"
  teamId      String?
  team        Team?     @relation(fields: [teamId], references: [id])
  
  aiExplanation String? // New: "IA dira el porque lo clasifica"
  
  tasks       KanbanTask[] // New: "asociado a un tablero canvan"

  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model KanbanTask {
  id          String   @id @default(uuid())
  title       String
  description String?
  
  status      KanbanStatus @default(TODO) // "3 estados Sin iniciar, en curso y cerrado"
  
  initiativeId String
  initiative   Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  
  assigneeId  String?
  assignee    User?    @relation(fields: [assigneeId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum Horizon {
  H1 // Core
  H2 // Emerging
  H3 // Future
}

enum KanbanStatus {
  TODO
  IN_PROGRESS
  DONE
}

// 4. Rituales de Seguimiento (Rituals)

model Ritual {
  id               String   @id @default(uuid())
  name             String   // "Ritual 1", "Ritual 2", etc.
  date             DateTime
  description      String?  // Optional context
  
  discussionPoints String?  // "Puntos tratados"
  commitments      String?  // "Compromisos"
  aiSuggestions    String?  // "Sugerencias de la IA"

  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  
  participants     RitualParticipant[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model RitualParticipant {
  id        String   @id @default(uuid())
  ritualId  String
  ritual    Ritual   @relation(fields: [ritualId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  @@unique([ritualId, userId])
}

// 5. Estrategia Emergente (Salazar's Framework)

model HardChoice {
  id          String   @id @default(uuid())
  description String   // "Oportunidad rechazada"
  reasoning   String   // "¿Por qué se rechazó?"
  date        DateTime @default(now())
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
}

model StrategicConversation {
  id          String   @id @default(uuid())
  topic       String   // "Tema de conversación"
  conclusion  String?
  participants String? // JSON string or text list
  date        DateTime @default(now())
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
}

model DistinctiveCapability {
  id          String   @id @default(uuid())
  name        String   // "Nombre de la capacidad"
  status      String   // "Developing", "Mature", "Core"
  evidence    String?  // "Pruebas de que existe"
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
}

model MarketValueMetric {
  id          String   @id @default(uuid())
  metricName  String   // "Indicador de Valor Creado"
  value       Float
  marketFeedback String? // "Feedback del mercado"
  date        DateTime @default(now())
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
}

model MutationLog {
  id          String   @id @default(uuid())
  observation String   // "Resultado inesperado"
  type        String   // "POSITIVE", "NEGATIVE"
  ignore      Boolean  @default(false)
  date        DateTime @default(now())
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
}
